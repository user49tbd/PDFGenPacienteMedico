CREATE 
--DROP
DATABASE MEDPAC
GO
USE MEDPAC
GO
CREATE TABLE MEDICO (
IDMED	INT				NOT NULL,
NOME	VARCHAR(100)	NOT NULL
PRIMARY KEY (IDMED)
)
GO
CREATE TABLE ESPECIALIDADE (
IDESPECIALIDADE	INT				NOT NULL,
ESPECIALIDADE	VARCHAR(50)	NOT NULL
PRIMARY KEY (IDESPECIALIDADE)
)
GO
CREATE TABLE PACIENTE (
IDPACIENTE	INT				NOT NULL,
NOME	VARCHAR(100)		NOT NULL,
DATA_NASC DATE				NOT NULL
PRIMARY KEY (IDPACIENTE)
)
GO
CREATE TABLE MEDICO_PACIENTE (
MEDICOIDMEDICO		INT				NOT NULL,
PACIENTEIDPACIENTE	INT				NOT NULL,
DATAHORA			DATETIME		NOT NULL,
CID					INT				NOT NULL,
TRATAMENTO			VARCHAR(50)		NOT NULL
PRIMARY KEY (MEDICOIDMEDICO,PACIENTEIDPACIENTE,DATAHORA)
FOREIGN KEY (MEDICOIDMEDICO) REFERENCES MEDICO(IDMED),
FOREIGN KEY (PACIENTEIDPACIENTE) REFERENCES PACIENTE(IDPACIENTE)
)
GO
CREATE TABLE MEDICO_ESPECIALIDADE(
MEDICOIDMEDICO		INT NOT NULL,
ESPECIDESPEC		INT	NOT NULL
PRIMARY KEY (MEDICOIDMEDICO,ESPECIDESPEC)
FOREIGN KEY (MEDICOIDMEDICO) REFERENCES MEDICO(IDMED),
FOREIGN KEY (ESPECIDESPEC) REFERENCES ESPECIALIDADE(IDESPECIALIDADE)
)
GO
GO
INSERT INTO PACIENTE
VALUES
(1,'PACIENTE-1','1963-05-18'),
(2,'PACIENTE-2','1993-07-15'),
(3,'PACIENTE-3','1968-05-11'),
(4,'PACIENTE-4','1983-04-12'),
(5,'PACIENTE-5','1973-02-13')
GO
INSERT INTO MEDICO
VALUES
(1,'MED1'),
(2,'MED2'),
(3,'MED3'),
(4,'MED4')
GO
INSERT INTO ESPECIALIDADE
VALUES
(1,'Especialista em Acupuntura'),
(2,'Especialista em Alergia e Imunologia'),
(3,'Especialista em Cardiologia'),
(4,'Especialista em Cirurgia Cardiovascular'),
(5,'Especialista em Cirurgia de Cabe�a e Pesco�o'),
(6,'Especialista em Cirurgia do Aparelho Digestivo'),
(7,'Especialista em Cirurgia Geral')
GO
CREATE 
--DROP
PROCEDURE RNDESPEC
AS
BEGIN
	DELETE MEDICO_ESPECIALIDADE
	DECLARE @ESPECV INT,
	        @I INT,
			@RND INT,
			@RG INT
	SET @RG = (SELECT COUNT(E.IDESPECIALIDADE) FROM ESPECIALIDADE E)-1
	SET @I = 1
	WHILE(@I <= (SELECT COUNT(M.IDMED) FROM MEDICO M))
	BEGIN
		SET @RND = (RAND()*@RG+1)
		INSERT INTO MEDICO_ESPECIALIDADE VALUES(@I,@RND)
		SET @I = @I + 1
	END
END
GO
EXEC RNDESPEC
GO
CREATE PROCEDURE CPROC @MEDICO VARCHAR(50),@PACIENTE VARCHAR(50),@CID INT
AS
BEGIN
DECLARE @IDMV VARCHAR(50),
		@TRAT VARCHAR(50),
		@IDPV VARCHAR(50),
		@IDMI INT,
		@IDPI INT,
		@CIDV INT
SET @IDMV = @MEDICO
SET @IDPV = @PACIENTE
SET @CIDV = @CID
SET @IDMI = (SELECT M.IDMED FROM MEDICO M WHERE M.NOME = @IDMV)
SET @IDPI = (SELECT P.IDPACIENTE FROM PACIENTE P WHERE P.NOME = @IDPV)
SET @TRAT = (SELECT ESPEC.ESPECIALIDADE FROM MEDICO M INNER JOIN MEDICO_ESPECIALIDADE ME ON ME.MEDICOIDMEDICO = M.IDMED INNER JOIN ESPECIALIDADE ESPEC 
ON ESPEC.IDESPECIALIDADE = ME.ESPECIDESPEC WHERE M.NOME = @IDMV)
INSERT INTO MEDICO_PACIENTE VALUES (@IDMI,@IDPI,CURRENT_TIMESTAMP,@CIDV,@TRAT)
END
GO
EXEC CPROC 'MED1','PACIENTE-1',12
GO
CREATE FUNCTION F_PACMED(@PN VARCHAR(50),@MN VARCHAR(50),@CID INT)
RETURNS @TAB TABLE(
PN VARCHAR(50),
MDN VARCHAR(50),
ESPEC VARCHAR(50),
DN VARCHAR(50),
DATA VARCHAR(10) ,
HORAS VARCHAR(100),
CID INT,
TRA VARCHAR(50)
)
AS
BEGIN
	INSERT INTO @TAB SELECT TOP 1 P.NOME AS PN,M.NOME AS MDN,ES.ESPECIALIDADE AS ESPEC,P.DATA_NASC AS DN,
	CONVERT(VARCHAR(10),MP.DATAHORA,120) AS DATA ,SUBSTRING(CONVERT(VARCHAR(100),MP.DATAHORA,120),11,120) AS HORAS,
	MP.CID,MP.TRATAMENTO AS TRA
	FROM MEDICO_PACIENTE MP INNER JOIN PACIENTE P ON MP.PACIENTEIDPACIENTE = P.IDPACIENTE
	INNER JOIN MEDICO M ON M.IDMED = MP.MEDICOIDMEDICO INNER JOIN MEDICO_ESPECIALIDADE ME
	ON ME.MEDICOIDMEDICO = M.IDMED INNER JOIN ESPECIALIDADE ES ON ES.IDESPECIALIDADE = ME.ESPECIDESPEC
	WHERE M.NOME = @PN AND P.NOME = @MN
	ORDER BY MP.DATAHORA DESC
	RETURN
END
SELECT PN,MDN,ESPEC,DN,DATA,HORAS,CID,TRA FROM dbo.F_PACMED ('MED1','PACIENTE-1',12)
